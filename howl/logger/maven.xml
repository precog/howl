<project default="jar:install" xmlns:j="jelly:core" xmlns:ant="jelly:ant">

    <!-- Check if the tests need to run -->
    <preGoal name="test:test">
        <j:if test="${context.getVariable('maven.test.force') == null}">
            <j:if test="${cloveroverride != 'true'}">
                <j:set var="uptodatePropName" value="tests.uptodate"/>
                <j:remove var="${uptodatePropName}"/>
                <ant:mkdir dir="${basedir}/target/test-reports/"/>
                <j:set var="uptodateFile" value="${basedir}/target/test-reports/tstamp"/>

                <ant:uptodate property="${uptodatePropName}" targetfile="${uptodateFile}">
                    <ant:srcfiles dir="${basedir}/src/" includes="**/*"/>
                </ant:uptodate>

                <j:if test="${context.getVariable(uptodatePropName) == 'true'}">
                    <ant:echo>NOTICE: Skipping tests; they seem to have passed already</ant:echo>
                    <j:set var="maven.test.skip" value="true"/>
                    <j:set var="unitTestSourcesPresent" value="false"/>
                </j:if>
            </j:if>
        </j:if>
    </preGoal>

    <!-- Update the timestamp of the last successful test -->
    <postGoal name="test:test">
        <j:if test="${context.getVariable('maven.test.failure') == null}">
            <ant:touch file="${basedir}/target/test-reports/tstamp"/>
        </j:if>
    </postGoal>

</project>
